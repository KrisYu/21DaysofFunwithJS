<!DOCTYPE html>
<html>
<head>
	<title>Game of Life</title>
	<style type="text/css">
		h1{
			text-align: center;
		}
		#gameboard{
			width: 500px;
			margin: auto;
		}
		#btns{
			width: 300px;
			margin: auto;
			padding-left: 50px;
			padding-top: 10px;
		}
		#gameboard td{
			border: 1px solid #eee;
			width: 16px;
			height: 16px;
		}
		td.alive {
			background-color: #8CC8DD;
		}
		td.dead {
			background-color: #fff;
		}


	</style>
</head>
<body>
	<h1>Game of Life</h1>
	<table id ="gameboard"></table>

	<div id="btns">
		<button id = "step_btn">Step</button>
		<button id = "play_btn">Play</button>
		<button id = "reset_btn">Reset Random</button>
		<button id = "clear_btn">Clear</button>
	</div>

	<script type="text/javascript">
		function setTable(){
			width = 20;
			height = 20;

			var tablehtml = '';
			for (var i = 0; i < height; i++) {
				tablehtml += "<tr>";
				for (var j = 0; j < width; j++) {
					tablehtml += "<td data-status='dead' id='" + i + "-" + j +"'></td>";
				}
				tablehtml += "</tr>";
			}

			document.getElementById("gameboard").innerHTML = tablehtml;

			toggleCell();

			const step_btn = document.getElementById("step_btn");
			step_btn.addEventListener('click',listenStep);
			listenStep();
			const play_btn = document.getElementById("play_btn");
			play_btn.addEventListener('click',playLife);
			const reset_btn = document.getElementById("reset_btn");
			reset_btn.addEventListener('click',randomGenerate);
			const clear_btn = document.getElementById("clear_btn");
			clear_btn.addEventListener('click',clearBoard);
		}

		function playLife(){
			setInterval(listenStep, 70);
		}

		function clearBoard(){
			for (var i = 0; i < height; i++) {
				for (var j = 0; j < width; j++) {
					board[i][j] = 0
				}
			}
			reDrawBoard();
		}



		function changeStatus(e){
			console.log(e);
			console.log(this); // 神来之笔
			if(this.getAttribute('data-status') == 'dead'){
				this.setAttribute('data-status','alive');
				this.setAttribute('class','alive')
			}
			else{
				this.setAttribute('data-status','dead');
				this.setAttribute('class','dead');
			}

		}

		function toggleCell(){
			const cellhtmls = document.getElementsByTagName("td");
			let cells = Array.from(cellhtmls);
			cells.forEach(cell => cell.addEventListener('click',changeStatus));
		}

		function listenStep(){
			board = new Array();
			for (var i = 0; i < height; i++) {
				board[i] = new Array();
				for (var j = 0; j < width; j++) {
					var id = i + '-' + j;
					if(document.getElementById(id).getAttribute("data-status") == 'dead')
					 	board[i][j] = 0;
					else
						board[i][j] = 1;
				}
			}
			console.log(board);

			updateNextState();
			reDrawBoard();
		}

        function updateNextState() {
            var i, j;
            for(i = 0; i < height; i++){
                for(j = 0; j < width; j++){
                    var curr = board[i][j];
                    var neighbors = countNeighbors(i, j);
                    if(neighbors < 2 || neighbors > 3){
                        if(curr === 1){
                            board[i][j] = 3;
                        }
                    }else if(neighbors === 3){
                        if(curr === 0){
                            board[i][j] = 2;
                        }
                    }
                }
            }
            for(i = 0; i < height; i++){
                for(j = 0; j < width; j++){
                    if(board[i][j] === 2){
                        board[i][j] = 1;
                    }else if(board[i][j] === 3){
                        board[i][j] = 0;
                    }
                }
            }

            function countNeighbors(i, j){
                var count = 0;
                count += isAlive(i, j - 1); count += isAlive(i, j + 1);
                count += isAlive(i - 1, j - 1); count += isAlive(i - 1, j); count += isAlive(i - 1, j + 1);
                count += isAlive(i + 1, j - 1); count += isAlive(i + 1, j); count += isAlive(i + 1, j + 1);
                return count;
            }
            function isAlive(i, j){
                if(!board[i] || !board[i][j]){
                    return 0;
                }
                var cell = board[i][j];
                if(cell === 1 || cell === 3){
                    return 1;
                }
                return 0;
            }
        }


		function reDrawBoard(){
			console.log(board);

			for (var i = 0; i < height; i++) {
				for (var j = 0; j < width; j++) {
					var id = i + '-' + j;
					cell = document.getElementById(id);
					if(board[i][j] == 1){
						cell.setAttribute('data-status','alive');
						cell.setAttribute('class','alive')

					} else{
						cell.setAttribute('data-status','dead');
						cell.setAttribute('class','dead');
					}
				}
			}
		}

		function randomGenerate(){
			for (var i = 0; i < height; i++) {
				for (var j = 0; j < width; j++) {
					if(Math.random() < 0.5)
						board[i][j] = 1
					else
						board[i][j] = 0
				}
			}
			reDrawBoard();
		}

	
	setTable();
	</script>

</body>
</html>